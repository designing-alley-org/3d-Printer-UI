<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Estimator Pro (UK)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #viewer-canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 0.5rem;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 9999px;
            margin-top: -6px;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">3D Print Estimator Pro</h1>
            <p class="text-lg text-gray-600 mt-2">Upload an STL, scale it, and get an instant quote (UK-based).</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg flex flex-col space-y-6">
                <h2 class="text-2xl font-bold border-b pb-3 text-gray-800">Configuration</h2>

                <div class="form-group">
                    <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-1">1. Upload STL File</label>
                    <input type="file" id="file-upload" accept=".stl" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                </div>

                <div class="form-group">
                    <label for="printer-select" class="block text-sm font-medium text-gray-700 mb-1">2. Select Printer</label>
                    <select id="printer-select" class="block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>

                <div class="form-group">
                    <label for="material-select" class="block text-sm font-medium text-gray-700 mb-1">3. Select Material</label>
                    <select id="material-select" class="block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                
                <div class="form-group">
                    <label for="scale-slider" class="block text-sm font-medium text-gray-700 mb-1">4. Scale Model</label>
                    <input type="range" id="scale-slider" min="10" max="300" step="1" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                    <div id="scale-display" class="text-center font-medium text-gray-600 mt-2">100%</div>
                </div>
                
                <div class="form-group">
                    <label for="infill-slider" class="block text-sm font-medium text-gray-700 mb-1">5. Infill Percentage</label>
                    <input type="range" id="infill-slider" min="0" max="100" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                    <div id="infill-display" class="text-center font-medium text-gray-600 mt-2">20%</div>
                </div>

                <div class="form-group">
                    <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-1">6. Model Color</label>
                    <input type="color" id="color-picker" value="#3b82f6" class="w-full h-12 p-1 border border-gray-300 rounded-md cursor-pointer"/>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <div id="viewer-container" class="relative w-full h-80 sm:h-96 lg:h-[30rem] bg-gray-200 rounded-lg overflow-hidden">
                    <canvas id="viewer-canvas"></canvas>
                    <div id="loader" class="absolute inset-0 flex items-center justify-center bg-gray-200 bg-opacity-80 backdrop-blur-sm text-gray-700 font-semibold hidden">
                        Loading Model...
                    </div>
                    <div id="viewer-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <p>Upload an STL file to see the model</p>
                    </div>
                </div>
                
                <div id="printability-status" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
                
                <div id="results-container" class="mt-6 hidden">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-3">Estimates</h3>
                    <div class="space-y-3 mt-4 text-gray-700">
                        <div class="flex justify-between items-center">
                            <span>Est. Weight:</span>
                            <strong id="result-weight" class="text-lg font-semibold text-gray-900">0 g</strong>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Est. Print Time:</span>
                            <strong id="result-time" class="text-lg font-semibold text-gray-900">00:00:00</strong>
                        </div>
                        <div class="border-t my-3"></div>
                         <div class="flex justify-between items-center text-sm">
                            <span>Filament Cost:</span>
                            <strong id="result-filament-cost">£0.00</strong>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span>Electricity Cost:</span>
                            <strong id="result-electricity-cost">£0.00</strong>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span>Labor Cost:</span>
                            <strong id="result-labor-cost">£0.00</strong>
                        </div>
                        <div class="border-t my-3 border-dashed"></div>
                        <div class="flex justify-between items-center text-blue-600">
                            <span class="text-xl font-bold">Total Est. Cost:</span>
                            <strong id="result-total-cost" class="text-2xl font-bold">£0.00</strong>
                        </div>
                    </div>
                </div>
                <div id="error-message" class="mt-6 p-4 bg-red-100 text-red-700 rounded-md hidden"></div>
            </div>
        </main>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';
        import { STLLoader } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/loaders/STLLoader.js';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/controls/OrbitControls.js';

        // --- CONSTANTS ---
        const ELECTRICITY_COST_GBP_PER_KWH = 0.28;
        const LABOR_COST_GBP_PER_HOUR = 7.50; 
        const SHELL_RATIO = 0.15;
        const INFILL_RATIO = 1.0 - SHELL_RATIO;
        const PRINT_SPEED_FACTOR = 0.7;
        const HEAT_UP_TIME_S = 5 * 60;
        
        // --- DATA ---
        const printerProfiles = new Map([
            ["Prusa i3 MK3S+", { name: "Prusa i3 MK3S+", buildVolume_mm: {x: 250, y: 210, z: 210}, nozzleDiameter_mm: 0.4, defaultLayerHeight_mm: 0.2, maxPrintSpeed_mm_s: 200, maxVolumetricFlow_mm3s: 15, powerConsumption_watts: 120 }],
            ["Creality Ender 3 V2", { name: "Creality Ender 3 V2", buildVolume_mm: {x: 220, y: 220, z: 250}, nozzleDiameter_mm: 0.4, defaultLayerHeight_mm: 0.2, maxPrintSpeed_mm_s: 180, maxVolumetricFlow_mm3s: 12, powerConsumption_watts: 150 }],
            ["Bambu Lab X1-Carbon", { name: "Bambu Lab X1-Carbon", buildVolume_mm: {x: 256, y: 256, z: 256}, nozzleDiameter_mm: 0.4, defaultLayerHeight_mm: 0.16, maxPrintSpeed_mm_s: 500, maxVolumetricFlow_mm3s: 21, powerConsumption_watts: 350 }],
            ["Creality K1", { name: "Creality K1", buildVolume_mm: {x: 220, y: 220, z: 250}, nozzleDiameter_mm: 0.4, defaultLayerHeight_mm: 0.2, maxPrintSpeed_mm_s: 600, maxVolumetricFlow_mm3s: 32, powerConsumption_watts: 360 }],
            ["Anycubic Kobra 2", { name: "Anycubic Kobra 2", buildVolume_mm: {x: 220, y: 220, z: 250}, nozzleDiameter_mm: 0.4, defaultLayerHeight_mm: 0.2, maxPrintSpeed_mm_s: 300, maxVolumetricFlow_mm3s: 18, powerConsumption_watts: 200 }],
        ]);
        const materials = new Map([
            ["PLA", { name: "PLA", density_g_cm3: 1.24, cost_gbp_per_kg: 20.00 }],
            ["ABS", { name: "ABS", density_g_cm3: 1.04, cost_gbp_per_kg: 22.00 }],
            ["PETG", { name: "PETG", density_g_cm3: 1.27, cost_gbp_per_kg: 25.00 }],
            ["TPU (Flexible)", { name: "TPU (Flexible)", density_g_cm3: 1.21, cost_gbp_per_kg: 35.00 }],
        ]);

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('file-upload');
        const printerSelect = document.getElementById('printer-select');
        const materialSelect = document.getElementById('material-select');
        const scaleSlider = document.getElementById('scale-slider');
        const scaleDisplay = document.getElementById('scale-display');
        const infillSlider = document.getElementById('infill-slider');
        const infillDisplay = document.getElementById('infill-display');
        const colorPicker = document.getElementById('color-picker');
        const loader = document.getElementById('loader');
        const viewerPlaceholder = document.getElementById('viewer-placeholder');
        const resultsContainer = document.getElementById('results-container');
        const printabilityStatus = document.getElementById('printability-status');
        const errorMessage = document.getElementById('error-message');
        const viewerContainer = document.getElementById('viewer-container');
        const canvas = document.getElementById('viewer-canvas');

        let modelData = null;
        let currentMesh = null;

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f2f5);
        const camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.1, 1000);
        camera.position.set(50, 50, 50);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(100, 100, 100);
        scene.add(directionalLight);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        const resizeObserver = new ResizeObserver(entries => {
            if (!entries || entries.length === 0) return;
            const { width, height } = entries[0].contentRect;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });
        resizeObserver.observe(viewerContainer);
        
        // --- CORE LOGIC ---

        function signedTetraVolume(p0x, p0y, p0z, p1x, p1y, p1z, p2x, p2y, p2z) {
            return (-p2x*p1y*p0z + p1x*p2y*p0z + p2x*p0y*p1z - p0x*p2y*p1z - p1x*p0y*p2z + p0x*p1y*p2z) / 6.0;
        }

        function calculateVolumeFromGeometry(geometry) {
            if (!geometry || !geometry.attributes.position) throw new Error("Invalid geometry for volume calculation.");
            const posArray = geometry.attributes.position.array;
            let totalSignedVolume = 0;
            if (geometry.index) {
                const index = geometry.index.array;
                for (let i = 0; i < index.length; i += 3) {
                    const i0 = index[i]*3, i1 = index[i+1]*3, i2 = index[i+2]*3;
                    totalSignedVolume += signedTetraVolume(posArray[i0],posArray[i0+1],posArray[i0+2], posArray[i1],posArray[i1+1],posArray[i1+2], posArray[i2],posArray[i2+1],posArray[i2+2]);
                }
            } else {
                for (let i = 0; i < posArray.length; i += 9) {
                     totalSignedVolume += signedTetraVolume(posArray[i],posArray[i+1],posArray[i+2], posArray[i+3],posArray[i+4],posArray[i+5], posArray[i+6],posArray[i+7],posArray[i+8]);
                }
            }
            return Math.abs(totalSignedVolume);
        }

        function populateSelects() {
            printerProfiles.forEach(p => printerSelect.add(new Option(p.name, p.name)));
            printerSelect.value = "Bambu Lab X1-Carbon";
            materials.forEach(m => materialSelect.add(new Option(m.name, m.name)));
        }
        
        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            loader.classList.remove('hidden');
            viewerPlaceholder.classList.add('hidden');
            errorMessage.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            printabilityStatus.classList.add('hidden');
            modelData = null;
            
            // Reset scale slider for new model
            scaleSlider.value = 100;
            scaleDisplay.textContent = '100%';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                setTimeout(() => {
                    try {
                        const geometry = new STLLoader().parse(e.target.result);
                        
                        if (currentMesh) {
                            scene.remove(currentMesh);
                            currentMesh.geometry.dispose();
                            currentMesh.material.dispose();
                        }

                        const material = new THREE.MeshStandardMaterial({ color: colorPicker.value, metalness: 0.3, roughness: 0.6 });
                        currentMesh = new THREE.Mesh(geometry, material);
                        scene.add(currentMesh);

                        const box = new THREE.Box3().setFromObject(currentMesh);
                        const center = box.getCenter(new THREE.Vector3());
                        currentMesh.position.sub(center);
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        
                        camera.position.z = camera.position.y = camera.position.x = maxDim * 1.5;
                        controls.target.set(0,0,0);
                        controls.update();

                        const volume = calculateVolumeFromGeometry(geometry);
                        modelData = { volume_mm3: volume, dimensions_mm: size };
                        
                        updateEstimates();
                        resultsContainer.classList.remove('hidden');

                    } catch (err) {
                        errorMessage.textContent = `Failed to parse STL. Ensure it's a valid file. Error: ${err.message}`;
                        errorMessage.classList.remove('hidden');
                        if (currentMesh) scene.remove(currentMesh);
                        viewerPlaceholder.classList.remove('hidden');
                    } finally {
                        loader.classList.add('hidden');
                    }
                }, 0);
            };
            reader.readAsArrayBuffer(file);
        }

        function calculateEstimates({ modelVolume_mm3, printer, material, infillPercent }) {
            const materialVolume_mm3 = modelVolume_mm3 * (SHELL_RATIO + (INFILL_RATIO * (infillPercent / 100)));
            const weight_g = materialVolume_mm3 * (material.density_g_cm3 / 1000);
            
            const timeForExtrusion_s = materialVolume_mm3 / (printer.nozzleDiameter_mm * printer.defaultLayerHeight_mm) / (printer.maxPrintSpeed_mm_s * PRINT_SPEED_FACTOR);
            const timeLimitedByFlow_s = materialVolume_mm3 / printer.maxVolumetricFlow_mm3s;
            const printTime_s = Math.max(timeForExtrusion_s, timeLimitedByFlow_s);
            const totalTime_s = printTime_s + HEAT_UP_TIME_S;

            const filamentCost_gbp = (weight_g / 1000) * material.cost_gbp_per_kg;
            const printTime_hr = totalTime_s / 3600;
            const electricityCost_gbp = (printer.powerConsumption_watts / 1000) * printTime_hr * ELECTRICITY_COST_GBP_PER_KWH;
            const laborCost_gbp = printTime_hr * LABOR_COST_GBP_PER_HOUR;
            const totalCost_gbp = filamentCost_gbp + electricityCost_gbp + laborCost_gbp;

            return { weight_g, totalTime_s, filamentCost_gbp, electricityCost_gbp, laborCost_gbp, totalCost_gbp };
        }

        function formatTime(s) {
            return new Date(s * 1000).toISOString().slice(11, 19);
        }
        
        function updateEstimates() {
            if (!modelData) return;
            
            const selectedPrinter = printerProfiles.get(printerSelect.value);
            const selectedMaterial = materials.get(materialSelect.value);
            const infill = parseInt(infillSlider.value, 10);
            const scale = parseInt(scaleSlider.value, 10) / 100;
            
            // --- Printability Check ---
            const scaledSize = modelData.dimensions_mm.clone().multiplyScalar(scale);
            const buildVol = selectedPrinter.buildVolume_mm;
            const fits = scaledSize.x <= buildVol.x && scaledSize.y <= buildVol.y && scaledSize.z <= buildVol.z;
            
            printabilityStatus.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (fits) {
                printabilityStatus.textContent = `Model fits on ${selectedPrinter.name}.`;
                printabilityStatus.classList.add('bg-green-100', 'text-green-800');
            } else {
                printabilityStatus.textContent = `Warning: Model is too large for ${selectedPrinter.name}'s build volume!`;
                printabilityStatus.classList.add('bg-red-100', 'text-red-800');
            }
            
            // --- Calculations ---
            // Volume scales by the cube of the linear scale factor
            const scaledVolume_mm3 = modelData.volume_mm3 * (scale ** 3);

            const estimates = calculateEstimates({
                modelVolume_mm3: scaledVolume_mm3,
                printer: selectedPrinter,
                material: selectedMaterial,
                infillPercent: infill,
            });

            if (estimates) {
                document.getElementById('result-weight').textContent = `${estimates.weight_g.toFixed(2)} g`;
                document.getElementById('result-time').textContent = formatTime(estimates.totalTime_s);
                document.getElementById('result-filament-cost').textContent = `£${estimates.filamentCost_gbp.toFixed(2)}`;
                document.getElementById('result-electricity-cost').textContent = `£${estimates.electricityCost_gbp.toFixed(2)}`;
                document.getElementById('result-labor-cost').textContent = `£${estimates.laborCost_gbp.toFixed(2)}`;
                document.getElementById('result-total-cost').textContent = `£${estimates.totalCost_gbp.toFixed(2)}`;
            }
        }
        
        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleFileChange);
        printerSelect.addEventListener('change', updateEstimates);
        materialSelect.addEventListener('change', updateEstimates);
        
        scaleSlider.addEventListener('input', (e) => {
            const scaleValue = parseInt(e.target.value, 10);
            scaleDisplay.textContent = `${scaleValue}%`;
            if (currentMesh) {
                const s = scaleValue / 100;
                currentMesh.scale.set(s, s, s);
            }
            updateEstimates();
        });
        
        infillSlider.addEventListener('input', (e) => {
            infillDisplay.textContent = `${e.target.value}%`;
            updateEstimates();
        });
        
        colorPicker.addEventListener('input', (e) => {
            if (currentMesh) {
                currentMesh.material.color.set(e.target.value);
            }
        });

        // --- INITIALIZATION ---
        populateSelects();
        animate();
    </script>
</body>
</html>